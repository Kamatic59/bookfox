// AI Response Generator (Standalone version for Supabase Editor)
// Internal function for testing and manual AI responses

import { serve } from 'https://deno.land/std@0.177.0/http/server.ts';
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.45.0';

// ============================================================================
// SUPABASE CLIENT
// ============================================================================
const supabaseUrl = Deno.env.get('SUPABASE_URL')!;
const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!;
const supabase = createClient(supabaseUrl, supabaseServiceKey);

// ============================================================================
// CORS HEADERS
// ============================================================================
const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

// ============================================================================
// GEMINI AI
// ============================================================================
const GEMINI_API_KEY = Deno.env.get('GEMINI_API_KEY')!;

async function generateAIResponse(customerMessage: string, context: any) {
  const systemPrompt = `You are ${context.assistantName}, a friendly AI assistant for ${context.businessName}.

Your job is to help potential customers via SMS:
1. Be warm, friendly, and professional (but not robotic)
2. Qualify leads by naturally gathering information
3. Offer to schedule appointments when appropriate
4. Keep responses SHORT - this is SMS, aim for 1-3 sentences max

RESPONSE FORMAT:
Always respond with valid JSON:
{
  "response": "Your SMS response text here",
  "intent": "greeting|inquiry|scheduling|objection|information|goodbye",
  "confidence": 0.95,
  "extracted": {"field_id": "value"}
}`;

  const messages = (context.messageHistory || []).map((m: any) => ({
    role: m.role === 'customer' ? 'user' : 'model',
    parts: [{ text: m.content }],
  }));
  
  messages.push({ role: 'user', parts: [{ text: customerMessage }] });

  const response = await fetch(
    `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`,
    {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        systemInstruction: { parts: [{ text: systemPrompt }] },
        contents: messages,
        generationConfig: { temperature: 0.7, maxOutputTokens: 200 },
      }),
    }
  );

  if (!response.ok) {
    throw new Error(`Gemini API error: ${response.status}`);
  }

  const data = await response.json();
  const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || '';

  try {
    const jsonMatch = aiText.match(/\{[\s\S]*\}/);
    if (jsonMatch) {
      const parsed = JSON.parse(jsonMatch[0]);
      return {
        response: parsed.response || aiText,
        intent: parsed.intent || 'inquiry',
        confidence: parsed.confidence || 0.8,
        extracted: parsed.extracted || {},
      };
    }
  } catch (e) {
    console.warn('Failed to parse AI response as JSON');
  }

  return { response: aiText.slice(0, 320), intent: 'inquiry', confidence: 0.5, extracted: {} };
}

// ============================================================================
// MAIN HANDLER
// ============================================================================
serve(async (req) => {
  // Handle CORS preflight
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders });
  }
  
  try {
    const { conversationId, message, action, businessId } = await req.json();
    
    if (action === 'greeting') {
      // Generate a greeting for a business
      const { data: business } = await supabase
        .from('businesses')
        .select('name')
        .eq('id', businessId)
        .single();
      
      const { data: aiSettings } = await supabase
        .from('ai_settings')
        .select('assistant_name')
        .eq('business_id', businessId)
        .single();
      
      const greeting = `Hi! This is ${aiSettings?.assistant_name || 'BookFox'} from ${business?.name || 'our company'}. I noticed we missed your call - how can I help you today? ðŸ¦Š`;
      
      return new Response(
        JSON.stringify({ greeting }),
        { headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }
    
    if (action === 'respond') {
      // Generate a response for a conversation
      if (!conversationId || !message) {
        throw new Error('conversationId and message are required');
      }
      
      // Get conversation with business
      const { data: conversation } = await supabase
        .from('conversations')
        .select('*, business:businesses(*)')
        .eq('id', conversationId)
        .single();
      
      if (!conversation) {
        throw new Error('Conversation not found');
      }
      
      const { data: aiSettings } = await supabase
        .from('ai_settings')
        .select('*')
        .eq('business_id', conversation.business_id)
        .single();
      
      // Get message history
      const { data: messages } = await supabase
        .from('messages')
        .select('direction, content, sender_type')
        .eq('conversation_id', conversationId)
        .order('created_at', { ascending: true })
        .limit(20);
      
      const messageHistory = (messages || []).map(m => ({
        role: m.sender_type === 'customer' ? 'customer' : 'ai',
        content: m.content,
      }));
      
      const context = {
        businessName: conversation.business.name,
        assistantName: aiSettings?.assistant_name || 'BookFox',
        messageHistory,
      };
      
      const result = await generateAIResponse(message, context);
      
      return new Response(
        JSON.stringify(result),
        { headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }
    
    throw new Error('Invalid action. Use "greeting" or "respond"');
    
  } catch (error) {
    console.error('AI respond error:', error);
    return new Response(
      JSON.stringify({ error: error.message }),
      { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    );
  }
});
